<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Bedtime Tales - Project Documentation</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --dark: #1e1b4b;
            --darker: #0f0d24;
            --light: #e0e7ff;
            --success: #10b981;
            --warning: #f59e0b;
            --code-bg: #1a1a2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: #e2e8f0;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.2) 0%, transparent 100%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #a5b4fc;
            font-size: 1.2rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--light);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(30, 27, 75, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h3 {
            color: var(--secondary);
            margin: 1.5rem 0 0.75rem;
        }

        code {
            background: var(--code-bg);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 0.9em;
            color: #a5f3fc;
        }

        pre {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 3px solid var(--primary);
        }

        pre code {
            background: none;
            padding: 0;
        }

        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 2rem;
            background: rgba(0,0,0,0.3);
            border-radius: 1rem;
            margin: 1.5rem 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.2), transparent);
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .flow-step:hover {
            transform: translateX(10px);
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content h4 {
            color: var(--light);
            margin-bottom: 0.25rem;
        }

        .step-content p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .arrow {
            text-align: center;
            color: var(--primary);
            font-size: 1.5rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }

        .collapsible {
            cursor: pointer;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .collapsible:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .collapsible::after {
            content: '+';
            font-size: 1.5rem;
            color: var(--primary);
            transition: transform 0.3s ease;
        }

        .collapsible.active::after {
            content: '-';
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 1rem;
        }

        .collapsible-content.show {
            max-height: 2000px;
            padding: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .tech-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--primary);
            border-radius: 2rem;
            font-size: 0.85rem;
            margin: 0.25rem;
        }

        .highlight {
            color: var(--secondary);
            font-weight: 600;
        }

        .ffmpeg-filter {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(99, 102, 241, 0.1));
            border: 1px solid rgba(236, 72, 153, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .filter-name {
            color: var(--secondary);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .filter-desc {
            color: #94a3b8;
            margin-top: 0.5rem;
        }

        .architecture-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            border: 2px solid;
            border-image: linear-gradient(135deg, var(--primary), var(--secondary)) 1;
            padding: 1.5rem;
            text-align: center;
            margin: 0.5rem;
            border-radius: 0.5rem;
        }

        .architecture-title {
            font-weight: bold;
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        .file-tree {
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
        }

        .file-tree .folder {
            color: var(--primary);
        }

        .file-tree .file {
            color: #94a3b8;
        }

        .file-tree .important {
            color: var(--secondary);
        }

        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dashed var(--primary);
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background: var(--dark);
            color: var(--light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--primary);
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .status-complete { background: var(--success); color: white; }
        .status-pending { background: var(--warning); color: black; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        th {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .audio-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 40px;
            margin: 1rem 0;
        }

        .audio-wave .bar {
            width: 4px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        .audio-wave .bar:nth-child(1) { animation-delay: 0s; }
        .audio-wave .bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-wave .bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-wave .bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-wave .bar:nth-child(5) { animation-delay: 0.4s; }
        .audio-wave .bar:nth-child(6) { animation-delay: 0.5s; }
        .audio-wave .bar:nth-child(7) { animation-delay: 0.6s; }
        .audio-wave .bar:nth-child(8) { animation-delay: 0.7s; }

        footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            border-top: 1px solid rgba(99, 102, 241, 0.3);
            color: #64748b;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Voice Bedtime Tales</h1>
            <p class="subtitle">AI-Powered Personalized Bedtime Stories in Your Voice</p>
            <div class="audio-wave">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <div style="margin-top: 1rem;">
                <span class="tech-badge">Next.js 16</span>
                <span class="tech-badge">React 19</span>
                <span class="tech-badge">TypeScript</span>
                <span class="tech-badge">FFmpeg</span>
                <span class="tech-badge">ElevenLabs</span>
                <span class="tech-badge">Google Gemini</span>
                <span class="tech-badge">MongoDB</span>
                <span class="tech-badge">Stripe</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="ffmpeg">FFmpeg Deep Dive</button>
            <button class="tab" data-tab="e2e">E2E Workflow</button>
            <button class="tab" data-tab="architecture">Architecture</button>
            <button class="tab" data-tab="api">API Endpoints</button>
            <button class="tab" data-tab="files">Project Structure</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="card">
                <h2>What is Voice Bedtime Tales?</h2>
                <p>Voice Bedtime Tales is a <span class="highlight">Next.js 16 web application</span> that creates personalized bedtime stories narrated in a parent's own cloned voice. The application combines:</p>
                <div class="grid" style="margin-top: 1.5rem;">
                    <div class="architecture-box">
                        <div class="architecture-title">AI Story Generation</div>
                        <p>Google Gemini 2.0 Flash creates age-appropriate, personalized stories</p>
                    </div>
                    <div class="architecture-box">
                        <div class="architecture-title">Voice Cloning</div>
                        <p>ElevenLabs clones parent's voice from 30-60 second sample</p>
                    </div>
                    <div class="architecture-box">
                        <div class="architecture-title">Audio Processing</div>
                        <p>FFmpeg mixes narration with dreamy background music</p>
                    </div>
                    <div class="architecture-box">
                        <div class="architecture-title">Payment Processing</div>
                        <p>Stripe handles secure payments for full stories</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Key Features</h2>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 0.5rem 0;"> Personalized stories featuring child's name, age, and interests</li>
                    <li style="padding: 0.5rem 0;"> Parent's voice cloned from just 30-60 seconds of audio</li>
                    <li style="padding: 0.5rem 0;"> Professional audio mixing with volume ducking</li>
                    <li style="padding: 0.5rem 0;"> Dreamy audio effects (lowpass filter, echo, reverb)</li>
                    <li style="padding: 0.5rem 0;"> Theme-matched background music</li>
                    <li style="padding: 0.5rem 0;"> 30-second free preview before payment</li>
                    <li style="padding: 0.5rem 0;"> Full 10-minute stories (~1500 words)</li>
                    <li style="padding: 0.5rem 0;"> Story library for voice history</li>
                </ul>
            </div>
        </div>

        <!-- FFMPEG TAB -->
        <div id="ffmpeg" class="tab-content">
            <div class="card">
                <h2>FFmpeg Integration Overview</h2>
                <p>FFmpeg is the <span class="highlight">core audio processing engine</span> in this project. It's used for professional-grade audio mixing, applying dreamy effects, and creating the final MP3 output.</p>

                <h3>Core File: <code>src/lib/audioMixer.ts</code></h3>
                <p>This is the main FFmpeg integration module with 346 lines of code handling all audio processing.</p>
            </div>

            <div class="card">
                <h2>Main Functions</h2>

                <div class="collapsible">
                    <span><code>mixNarrationWithMusic()</code> - Lines 37-103</span>
                </div>
                <div class="collapsible-content">
                    <p>The primary mixing function that combines narration with background music.</p>
                    <pre><code>const mixResult = await mixNarrationWithMusic({
  narrationBuffer,           // Voice narration audio
  musicUrl: musicResult.url, // Background music URL
  musicVolume: 0.25,         // 25% volume for music
  ducking: true,             // Enable sidechain compression
  duckingAmount: 0.5,        // 50% ducking intensity
  fadeInDuration: 2,         // 2 second fade in
  fadeOutDuration: 3,        // 3 second fade out
});</code></pre>
                </div>

                <div class="collapsible">
                    <span><code>buildMixFilter()</code> - Lines 153-215</span>
                </div>
                <div class="collapsible-content">
                    <p>Constructs the FFmpeg filter_complex chain for audio processing.</p>
                    <pre><code>// With Ducking (Advanced):
[0:a]&lt;dreamy_effects&gt;[voice]
[1:a]aloop,atrim,volume,afade[musicfaded]
[musicfaded][voice]sidechaincompress[musicducked]
[voice][musicducked]amix,loudnorm[final]

// Without Ducking (Simple):
[0:a]&lt;dreamy_effects&gt;[voice]
[1:a]aloop,atrim,volume,afade[music]
[voice][music]amix,loudnorm[final]</code></pre>
                </div>

                <div class="collapsible">
                    <span><code>getAudioDuration()</code> - Lines 220-244</span>
                </div>
                <div class="collapsible-content">
                    <p>Uses <code>ffprobe</code> to get audio duration before mixing.</p>
                    <pre><code>const ffprobe = spawn('ffprobe', [
  '-v', 'quiet',
  '-print_format', 'json',
  '-show_format',
  filePath
]);</code></pre>
                </div>

                <div class="collapsible">
                    <span><code>normalizeAudio()</code> - Lines 321-345</span>
                </div>
                <div class="collapsible-content">
                    <p>Applies loudness normalization to broadcast standards.</p>
                    <pre><code>const args = [
  '-i', inputPath,
  '-af', 'loudnorm=I=-16:TP=-1.5:LRA=11',
  '-acodec', 'libmp3lame',
  '-b:a', '192k',
  outputPath
];</code></pre>
                </div>
            </div>

            <div class="card">
                <h2>FFmpeg Filters Used</h2>
                <div class="grid">
                    <div class="ffmpeg-filter">
                        <div class="filter-name">lowpass=f=8000</div>
                        <div class="filter-desc">Warms the voice by cutting harshness above 8kHz</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">aecho</div>
                        <div class="filter-desc">Adds echo delays (100ms, 200ms, 300ms) with decay for dreamy effect</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">aloop=loop=-1</div>
                        <div class="filter-desc">Loops music indefinitely to match narration length</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">atrim=0:duration</div>
                        <div class="filter-desc">Trims audio to specific duration</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">volume=0.25</div>
                        <div class="filter-desc">Sets background music to 25% volume</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">afade</div>
                        <div class="filter-desc">Applies fade in/out effects for smooth transitions</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">sidechaincompress</div>
                        <div class="filter-desc">Ducks music volume when voice is present (the magic!)</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">amix</div>
                        <div class="filter-desc">Mixes multiple audio streams together</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">loudnorm</div>
                        <div class="filter-desc">Normalizes to -16 LUFS (broadcast standard)</div>
                    </div>
                    <div class="ffmpeg-filter">
                        <div class="filter-name">aformat</div>
                        <div class="filter-desc">Standardizes audio format (44.1kHz, stereo, float)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Complete Filter Chain Example</h2>
                <p>Here's the actual FFmpeg filter_complex used for mixing with dreamy effects and ducking:</p>
                <pre><code>[0:a]lowpass=f=8000,aecho=0.8:0.5:100|200|300:0.5|0.35|0.2,
    aecho=0.8:0.4:500|700:0.3|0.2,
    aformat=sample_fmts=fltp:sample_rates=44100:channel_layouts=stereo[voice];

[1:a]aloop=loop=-1:size=2e+09,atrim=0:300[musicloop];

[musicloop]volume=0.25,
    afade=t=in:st=0:d=2,
    afade=t=out:st=297:d=3[musicfaded];

[musicfaded][voice]sidechaincompress=threshold=0.02:ratio=4:
    attack=50:release=400:level_sc=0.5[musicducked];

[voice][musicducked]amix=inputs=2:duration=first:dropout_transition=2,
    loudnorm=I=-16:TP=-1.5:LRA=11[final]</code></pre>
            </div>

            <div class="card">
                <h2>Where FFmpeg is Used in the Project</h2>
                <table>
                    <tr>
                        <th>Location</th>
                        <th>Purpose</th>
                        <th>Fallback</th>
                    </tr>
                    <tr>
                        <td><code>/api/story/preview</code></td>
                        <td>Mix 30-second preview with music</td>
                        <td>Narration-only audio</td>
                    </tr>
                    <tr>
                        <td><code>/api/story/full</code></td>
                        <td>Mix full 10-minute story with music</td>
                        <td>Narration-only audio</td>
                    </tr>
                    <tr>
                        <td><code>/api/audio/mix</code></td>
                        <td>Re-mix existing stories on demand</td>
                        <td>Returns error</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- E2E WORKFLOW TAB -->
        <div id="e2e" class="tab-content">
            <div class="card">
                <h2>End-to-End User Journey</h2>
                <div class="flow-diagram">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Landing Page</h4>
                            <p>User arrives at the 5-step wizard on <code>/page.tsx</code></p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Identity Selection (Step 1)</h4>
                            <p>Enter email OR existing ElevenLabs Voice ID. Calls <code>/api/voice/check</code></p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Child Information (Step 2)</h4>
                            <p>Enter child's name and age (2-10 years)</p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>Story Customization (Step 3)</h4>
                            <p>Select interests, theme (adventure, magical, etc.), optional custom prompt</p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <h4>Voice Recording (Step 4 - New Users Only)</h4>
                            <p>Record 30-60 seconds using <code>VoiceRecorder.tsx</code> with MediaRecorder API</p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <h4>Processing State</h4>
                            <p>Voice cloning via ElevenLabs, story generation via Gemini, audio mixing via FFmpeg</p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">7</div>
                        <div class="step-content">
                            <h4>Preview Page</h4>
                            <p>Listen to 30-second sample at <code>/preview/[id]</code></p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">8</div>
                        <div class="step-content">
                            <h4>Payment or Free Access</h4>
                            <p>Stripe checkout or bypass with <code>FreeAccessButton</code></p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">9</div>
                        <div class="step-content">
                            <h4>Full Story Generation</h4>
                            <p>10-minute story generated, mixed, and uploaded to Vercel Blob</p>
                        </div>
                    </div>
                    <div class="arrow"></div>

                    <div class="flow-step">
                        <div class="step-number">10</div>
                        <div class="step-content">
                            <h4>Story Playback & Download</h4>
                            <p>Full story at <code>/story/[id]</code> with download option</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Technical Flow: Preview Generation</h2>
                <div class="grid">
                    <div>
                        <h3>1. API Request</h3>
                        <pre><code>POST /api/story/preview
{
  email: "parent@example.com",
  childName: "Emma",
  childAge: 5,
  interests: "dinosaurs, space",
  theme: "adventure"
}</code></pre>
                    </div>
                    <div>
                        <h3>2. Story Generation (Gemini)</h3>
                        <pre><code>const storyContent = await
  generatePreviewStory(
    childName,
    childAge,
    interests,
    theme
  );
// Returns ~100 words + music prompt</code></pre>
                    </div>
                    <div>
                        <h3>3. Text-to-Speech (ElevenLabs)</h3>
                        <pre><code>const narrationBuffer = await
  textToSpeech(
    storyContent.story,
    elevenlabsVoiceId
  );
// Returns audio buffer</code></pre>
                    </div>
                    <div>
                        <h3>4. Audio Mixing (FFmpeg)</h3>
                        <pre><code>const mixResult = await
  mixNarrationWithMusic({
    narrationBuffer,
    musicUrl: musicResult.url,
    musicVolume: 0.25,
    ducking: true,
  });
// Returns mixed MP3</code></pre>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Story Status Lifecycle</h2>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin-top: 1rem;">
                    <div class="architecture-box" style="flex: 1; min-width: 150px;">
                        <div class="status-badge status-pending">preview</div>
                        <p style="margin-top: 0.5rem;">Initial state after preview created</p>
                    </div>
                    <div style="font-size: 2rem; color: var(--primary); display: flex; align-items: center;"></div>
                    <div class="architecture-box" style="flex: 1; min-width: 150px;">
                        <div class="status-badge status-pending">paid</div>
                        <p style="margin-top: 0.5rem;">After successful Stripe payment</p>
                    </div>
                    <div style="font-size: 2rem; color: var(--primary); display: flex; align-items: center;"></div>
                    <div class="architecture-box" style="flex: 1; min-width: 150px;">
                        <div class="status-badge status-pending">generating</div>
                        <p style="margin-top: 0.5rem;">Full story being generated</p>
                    </div>
                    <div style="font-size: 2rem; color: var(--primary); display: flex; align-items: center;"></div>
                    <div class="architecture-box" style="flex: 1; min-width: 150px;">
                        <div class="status-badge status-complete">complete</div>
                        <p style="margin-top: 0.5rem;">Ready for playback/download</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE TAB -->
        <div id="architecture" class="tab-content">
            <div class="card">
                <h2>System Architecture Diagram</h2>
                <pre style="text-align: center; font-size: 0.8rem;">
        Frontend (Next.js 16, React 19, TypeScript)
         Home/Wizard Page (5 steps)
         Voice Recorder (MediaRecorder API)
         Audio Player Component
         Preview & Story Pages

                  Next.js Routes

    ┌────────────┼────────────────────────────┐
    │            │                            │
    ▼            ▼                            ▼
 Voice        Story APIs             Payment/Library
 APIs                                 APIs
 • check      • preview               • checkout
 • upload     • full                  • webhook
 • clone      • mix                   • albums/library

     External APIs & Services

  ┌─────────────────┐  ┌──────────────────┐
  │  ElevenLabs     │  │ Google Gemini    │
  │ • Voice Clone   │  │ • Story Gen      │
  │ • TTS           │  │ • Gemini 2.0     │
  │ (v3 model)      │  │   Flash          │
  └────────┬────────┘  └────────┬─────────┘
           │                    │
  ┌────────▼───────────────────▼──┐
  │    FFmpeg Processing          │
  │ • Audio Mixing                │
  │ • Volume Ducking              │
  │ • Dreamy Effects              │
  │ • MP3 Encoding (192k)         │
  └────────────────────────────────┘

              Storage & Databases

  ┌──────────────────┐        ┌────────────────┐
  │ MongoDB Atlas    │        │ Vercel Blob    │
  │ • Users          │        │ • Voice        │
  │ • Stories        │        │   samples      │
  │ • Metadata       │        │ • Preview MP3  │
  │                  │        │ • Full Story   │
  └──────────────────┘        └────────────────┘
                </pre>
            </div>

            <div class="card">
                <h2>Database Models</h2>
                <div class="grid">
                    <div>
                        <h3>User Model <code>src/models/User.ts</code></h3>
                        <pre><code>{
  email: string,
  phone?: string,
  elevenlabsVoiceId?: string,
  stripeCustomerId?: string,
  voiceSampleUrl?: string,
  createdAt: Date,
  updatedAt: Date
}</code></pre>
                    </div>
                    <div>
                        <h3>Story Model <code>src/models/Story.ts</code></h3>
                        <pre><code>{
  userId: ObjectId,
  childName: string,
  childAge: number,
  interests: string,
  theme: string,
  customPrompt?: string,
  previewText?: string,
  previewUrl?: string,
  storyText?: string,
  fullAudioUrl?: string,
  status: 'preview' | 'paid' |
          'generating' | 'complete',
  musicSource?: string,
  hasMusicMixed?: boolean
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>External Service Integrations</h2>
                <table>
                    <tr>
                        <th>Service</th>
                        <th>Purpose</th>
                        <th>Integration File</th>
                    </tr>
                    <tr>
                        <td><strong>ElevenLabs</strong></td>
                        <td>Voice cloning & TTS with v3 model</td>
                        <td><code>src/lib/elevenlabs.ts</code></td>
                    </tr>
                    <tr>
                        <td><strong>Google Gemini</strong></td>
                        <td>AI story generation (Gemini 2.0 Flash)</td>
                        <td><code>src/lib/gemini.ts</code></td>
                    </tr>
                    <tr>
                        <td><strong>FFmpeg</strong></td>
                        <td>Audio mixing with advanced filters</td>
                        <td><code>src/lib/audioMixer.ts</code></td>
                    </tr>
                    <tr>
                        <td><strong>Mubert</strong></td>
                        <td>AI-generated background music</td>
                        <td><code>src/lib/music.ts</code></td>
                    </tr>
                    <tr>
                        <td><strong>Stripe</strong></td>
                        <td>Payment processing</td>
                        <td><code>src/lib/stripe.ts</code></td>
                    </tr>
                    <tr>
                        <td><strong>MongoDB</strong></td>
                        <td>Database for users and stories</td>
                        <td><code>src/lib/mongodb.ts</code></td>
                    </tr>
                    <tr>
                        <td><strong>Vercel Blob</strong></td>
                        <td>Audio file storage</td>
                        <td><code>src/lib/blob.ts</code></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- API ENDPOINTS TAB -->
        <div id="api" class="tab-content">
            <div class="card">
                <h2>API Endpoints</h2>

                <h3>Voice APIs</h3>
                <table>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>/api/voice/check</code></td>
                        <td>POST</td>
                        <td>Check if user has existing voice clone</td>
                    </tr>
                    <tr>
                        <td><code>/api/voice/upload</code></td>
                        <td>POST</td>
                        <td>Upload voice sample and create clone</td>
                    </tr>
                    <tr>
                        <td><code>/api/voice/clone</code></td>
                        <td>POST</td>
                        <td>Clone voice from uploaded sample</td>
                    </tr>
                </table>

                <h3>Story APIs</h3>
                <table>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>/api/story/preview</code></td>
                        <td>POST</td>
                        <td>Generate 30-second story preview</td>
                    </tr>
                    <tr>
                        <td><code>/api/story/full</code></td>
                        <td>POST</td>
                        <td>Generate full 10-minute story</td>
                    </tr>
                    <tr>
                        <td><code>/api/story/[id]</code></td>
                        <td>GET</td>
                        <td>Fetch story details by ID</td>
                    </tr>
                </table>

                <h3>Audio API</h3>
                <table>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>/api/audio/mix</code></td>
                        <td>POST</td>
                        <td>Re-mix existing story with different settings</td>
                    </tr>
                </table>

                <h3>Payment APIs</h3>
                <table>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>/api/checkout</code></td>
                        <td>POST</td>
                        <td>Create Stripe checkout session</td>
                    </tr>
                    <tr>
                        <td><code>/api/webhook</code></td>
                        <td>POST</td>
                        <td>Handle Stripe webhooks</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h2>Example API Requests</h2>

                <div class="collapsible">
                    <span>POST /api/story/preview</span>
                </div>
                <div class="collapsible-content">
                    <pre><code>// Request
{
  "email": "parent@example.com",
  "childName": "Emma",
  "childAge": 5,
  "interests": "dinosaurs, space",
  "theme": "adventure",
  "customPrompt": "Include a friendly T-Rex named Rex"
}

// Response
{
  "success": true,
  "storyId": "507f1f77bcf86cd799439011",
  "previewUrl": "https://blob.vercel-storage.com/preview.mp3",
  "previewText": "Emma looked up at the stars..."
}</code></pre>
                </div>

                <div class="collapsible">
                    <span>POST /api/voice/upload</span>
                </div>
                <div class="collapsible-content">
                    <pre><code>// Request
{
  "audio": "data:audio/webm;base64,GkXfo59...",
  "userId": "507f1f77bcf86cd799439012"
}

// Response
{
  "success": true,
  "voiceId": "elv_abc123xyz",
  "message": "Voice cloned successfully"
}</code></pre>
                </div>
            </div>
        </div>

        <!-- FILES TAB -->
        <div id="files" class="tab-content">
            <div class="card">
                <h2>Project Structure</h2>
                <div class="file-tree">
<pre>
<span class="folder">src/</span>
├── <span class="folder">app/</span>                          <span style="color:#64748b"># Next.js 16 App Router</span>
│   ├── <span class="file">page.tsx</span>                  <span style="color:#64748b"># Main landing/wizard page</span>
│   ├── <span class="file">layout.tsx</span>
│   ├── <span class="file">globals.css</span>
│   ├── <span class="folder">api/</span>                      <span style="color:#64748b"># API routes</span>
│   │   ├── <span class="folder">audio/mix/</span>
│   │   ├── <span class="folder">voice/</span>               <span style="color:#64748b"># Voice cloning endpoints</span>
│   │   ├── <span class="folder">story/</span>               <span style="color:#64748b"># Story generation endpoints</span>
│   │   ├── <span class="folder">library/</span>             <span style="color:#64748b"># Library/album endpoints</span>
│   │   ├── <span class="folder">checkout/</span>            <span style="color:#64748b"># Stripe checkout</span>
│   │   └── <span class="folder">webhook/</span>             <span style="color:#64748b"># Stripe webhook handler</span>
│   ├── <span class="folder">preview/[id]/</span>            <span style="color:#64748b"># 30-second preview page</span>
│   ├── <span class="folder">story/[id]/</span>              <span style="color:#64748b"># Full story playback page</span>
│   └── <span class="folder">album/[voiceId]/</span>         <span style="color:#64748b"># Voice history (library)</span>
├── <span class="folder">components/</span>                  <span style="color:#64748b"># React components</span>
│   ├── <span class="important">VoiceRecorder.tsx</span>        <span style="color:#64748b"># MediaRecorder for voice input</span>
│   ├── <span class="important">AudioPlayer.tsx</span>          <span style="color:#64748b"># Custom audio player</span>
│   ├── <span class="file">StoryForm.tsx</span>
│   ├── <span class="file">PaymentButton.tsx</span>
│   ├── <span class="file">FreeAccessButton.tsx</span>
│   ├── <span class="folder">player/</span>                  <span style="color:#64748b"># Player provider & controls</span>
│   └── <span class="folder">library/</span>                 <span style="color:#64748b"># Album/library components</span>
├── <span class="folder">lib/</span>                         <span style="color:#64748b"># Utility libraries</span>
│   ├── <span class="important">audioMixer.ts</span>            <span style="color:#64748b"># FFmpeg-based audio mixing (346 lines)</span>
│   ├── <span class="important">elevenlabs.ts</span>            <span style="color:#64748b"># Voice cloning + TTS</span>
│   ├── <span class="important">gemini.ts</span>                <span style="color:#64748b"># Story generation with Google Gemini</span>
│   ├── <span class="file">music.ts</span>                 <span style="color:#64748b"># Music selection & Mubert integration</span>
│   ├── <span class="file">blob.ts</span>                  <span style="color:#64748b"># Vercel Blob storage helpers</span>
│   ├── <span class="file">stripe.ts</span>                <span style="color:#64748b"># Stripe payment integration</span>
│   ├── <span class="file">mongodb.ts</span>               <span style="color:#64748b"># Database connection</span>
│   └── <span class="file">features.ts</span>              <span style="color:#64748b"># Feature flags</span>
└── <span class="folder">models/</span>                      <span style="color:#64748b"># MongoDB schemas</span>
    ├── <span class="file">User.ts</span>                  <span style="color:#64748b"># User document</span>
    └── <span class="file">Story.ts</span>                 <span style="color:#64748b"># Story document</span>
</pre>
                </div>
            </div>

            <div class="card">
                <h2>Key Configuration Files</h2>
                <div class="grid">
                    <div>
                        <h3>package.json</h3>
                        <pre><code>{
  "dependencies": {
    "next": "^16.0.0",
    "react": "^19.0.0",
    "mongoose": "^8.x",
    "stripe": "^14.x",
    "@vercel/blob": "^0.x"
  }
}</code></pre>
                    </div>
                    <div>
                        <h3>.env.local</h3>
                        <pre><code># Required
MONGODB_URI=mongodb+srv://...
ELEVENLABS_API_KEY=sk_...
GEMINI_API_KEY=AIza...

# Optional (if bypassing payments)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...</code></pre>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Feature Flags</h2>
                <p>Located in <code>src/lib/features.ts</code>:</p>
                <pre><code>export const Features = {
  BYPASS_PAYMENT: true,       // Skip Stripe, allow free access
  MOCK_VOICE_CLONE: false,    // Use mock voice cloning
  MOCK_STORY_GENERATION: false // Use mock story generation
}</code></pre>
            </div>
        </div>
    </div>

    <footer>
        <p>Voice Bedtime Tales - AI-Powered Personalized Bedtime Stories</p>
        <p style="margin-top: 0.5rem;">Built with Next.js 16, React 19, FFmpeg, ElevenLabs, and Google Gemini</p>
    </footer>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Add active to clicked tab
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Collapsible sections
        document.querySelectorAll('.collapsible').forEach(collapsible => {
            collapsible.addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                content.classList.toggle('show');
            });
        });
    </script>
</body>
</html>
</code></pre>
